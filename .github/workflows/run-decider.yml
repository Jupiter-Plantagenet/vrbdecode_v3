name: Run Decider Pipeline

on:
  workflow_dispatch:
    inputs:
      steps:
        description: 'Number of steps to run'
        required: false
        default: '32'
        type: string

jobs:
  run-decider:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup swap (mitigate OOM)
      run: |
        sudo fallocate -l 8G /swapfile || sudo dd if=/dev/zero of=/swapfile bs=1M count=8192
        sudo chmod 600 /swapfile
        sudo mkswap /swapfile
        sudo swapon /swapfile
        free -h
      
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: stable
        
    - name: Cache cargo registry
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        
    - name: Build decider_evm
      run: |
        cargo build -j 1 --release --bin decider_evm
        
    - name: Install Python dependencies
      run: |
        pip install -r requirements.txt || true
        
    - name: Run decider pipeline
      id: run_decider
      continue-on-error: true
      env:
        VRBDECODE_DECIDER_BIN: ${{ github.workspace }}/target/release/decider_evm
        VRBDECODE_HEARTBEAT_S: "30"
        VRBDECODE_BENCH_PROGRESS: "1"
        RUST_BACKTRACE: "1"
        RAYON_NUM_THREADS: "1"
        CARGO_BUILD_JOBS: "1"
      run: |
        cd eval
        python run_icbc.py --steps ${{ github.event.inputs.steps || '32' }}

    - name: Diagnostics (on failure)
      if: always()
      run: |
        echo "== free -h =="
        free -h
        echo "== dmesg tail =="
        sudo dmesg | tail -n 200 || true
        
    - name: Upload artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: decider-artifacts
        path: |
          eval/icbc_decider_evm.json
          eval/icbc_decider_evm.csv
          eval/evm/*.sol
          eval/evm/*.calldata
        if-no-files-found: ignore
        retention-days: 30

    - name: Fail job if decider failed
      if: steps.run_decider.outcome != 'success'
      run: exit 1
